
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR RPG Adventure</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .landing-page {
            text-align: center;
            padding: 50px 0;
        }
        
        .title {
            font-size: 3rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .subtitle {
            font-size: 1.5rem;
            margin-bottom: 30px;
            opacity: 0.9;
        }
        
        .start-button {
            background: #FFD700;
            color: #333;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .start-button:hover {
            background: #FFA500;
            transform: scale(1.05);
        }
        
        .game-page {
            display: none;
        }
        
        .character-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .character-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .character-card:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-5px);
            border-color: #FFD700;
        }
        
        .character-card.selected {
            background: rgba(255,215,0,0.3);
            border-color: #FFD700;
        }
        
        .character-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .character-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .character-stats {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .game-area {
            display: none;
        }
        
        .stats {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .camera-container {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        #camera {
            width: 100%;
            max-width: 400px;
            height: 300px;
            background: #000;
            border-radius: 10px;
            margin: 0 auto;
            display: block;
        }
        
        .location-info {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .enemy-info {
            background: rgba(255,0,0,0.2);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        
        .enemy-icon {
            font-size: 4rem;
            margin-bottom: 10px;
        }
        
        .health-bar {
            width: 100%;
            height: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #FF6B6B, #FF8E8E);
            transition: width 0.5s ease;
        }
        
        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-button {
            background: linear-gradient(45deg, #FF6B6B, #FF8E8E);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .action-button:hover {
            transform: scale(1.05);
        }
        
        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .message {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
        }
        
        .error {
            background: rgba(255,0,0,0.2);
        }
        
        .success {
            background: rgba(0,255,0,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Landing Page -->
        <div id="landingPage" class="landing-page">
            <h1 class="title">‚öîÔ∏è AR RPG Adventure ‚öîÔ∏è</h1>
            <p class="subtitle">Battle enemies in the real world with augmented reality!</p>
            <button class="start-button" onclick="startGame()">Start Adventure</button>
        </div>
        
        <!-- Character Selection -->
        <div id="characterSelection" class="game-page">
            <h2>Choose Your Hero</h2>
            <div class="character-selection">
                <div class="character-card" onclick="selectCharacter('warrior')">
                    <div class="character-icon">‚öîÔ∏è</div>
                    <div class="character-name">Warrior</div>
                    <div class="character-stats">HP: 120 | ATK: 15</div>
                    <div class="character-stats">Skills: Power Strike, Shield Bash, Battle Heal</div>
                </div>
                <div class="character-card" onclick="selectCharacter('mage')">
                    <div class="character-icon">üîÆ</div>
                    <div class="character-name">Mage</div>
                    <div class="character-stats">HP: 80 | ATK: 25</div>
                    <div class="character-stats">Skills: Fireball, Arcane Missiles, Mana Shield</div>
                </div>
                <div class="character-card" onclick="selectCharacter('archer')">
                    <div class="character-icon">üèπ</div>
                    <div class="character-name">Archer</div>
                    <div class="character-stats">HP: 100 | ATK: 18</div>
                    <div class="character-stats">Skills: Precise Shot, Rain of Arrows, Nature's Heal</div>
                </div>
                <div class="character-card" onclick="selectCharacter('healer')">
                    <div class="character-icon">üíö</div>
                    <div class="character-name">Healer</div>
                    <div class="character-stats">HP: 110 | ATK: 12</div>
                    <div class="character-stats">Skills: Holy Light, Greater Heal, Divine Blessing</div>
                </div>
                <div class="character-card" onclick="selectCharacter('rogue')">
                    <div class="character-icon">üó°Ô∏è</div>
                    <div class="character-name">Rogue</div>
                    <div class="character-stats">HP: 90 | ATK: 20</div>
                    <div class="character-stats">Skills: Backstab, Poison Blade, Shadow Mend</div>
                </div>
            </div>
        </div>
        
        <!-- Game Area -->
        <div id="gameArea" class="game-area">
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-label">Level</div>
                    <div class="stat-value" id="level">1</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">HP</div>
                    <div class="stat-value" id="hp">100/100</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">XP</div>
                    <div class="stat-value" id="xp">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Kills</div>
                    <div class="stat-value" id="kills">0</div>
                </div>
            </div>
            
            <div class="camera-container">
                <h3>üì∑ AR Camera View</h3>
                <video id="camera" autoplay playsinline></video>
                <div class="message">
                    Camera will show AR view with enemies
                </div>
            </div>
            
            <div class="location-info">
                <h3>üìç Location Status</h3>
                <p id="locationStatus">Getting location...</p>
                <p id="distanceInfo">Distance traveled: 0m</p>
            </div>
            
            <div id="enemyInfo" class="enemy-info">
                <h3>‚öîÔ∏è Enemy Encountered!</h3>
                <div class="enemy-icon" id="enemyIcon">üëπ</div>
                <div class="enemy-name" id="enemyName">Goblin</div>
                <div class="health-bar">
                    <div class="health-fill" id="enemyHealth" style="width: 100%"></div>
                </div>
                <div id="enemyStats">HP: 30/30</div>
            </div>
            
            <div class="actions">
                <button class="action-button" onclick="playerAttack()" id="attackBtn">‚öîÔ∏è Attack</button>
                <button class="action-button" onclick="useSkill()" id="skillBtn">‚ú® Use Skill</button>
                <button class="action-button" onclick="heal()" id="healBtn">üíö Heal</button>
                <button class="action-button" onclick="escape()" id="escapeBtn">üèÉ Escape</button>
            </div>
            
            <div id="messageArea"></div>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            playerId: null,
            player: null,
            enemy: null,
            inCombat: false,
            lastLocation: null,
            cameraStream: null
        };

        // Start Game
        function startGame() {
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('characterSelection').style.display = 'block';
            initCamera();
        }

        // Initialize Camera
        async function initCamera() {
            try {
                const video = document.getElementById('camera');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' },
                    audio: false 
                });
                video.srcObject = stream;
                gameState.cameraStream = stream;
                showMessage('Camera initialized successfully!', 'success');
            } catch (error) {
                console.error('Camera error:', error);
                showMessage('Camera access denied or not available', 'error');
                // Fallback: show placeholder
                document.getElementById('camera').style.display = 'none';
            }
        }

        // Select Character
        async function selectCharacter(characterClass) {
            try {
                const response = await fetch('/select-character', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ character: characterClass })
                });
                
                const data = await response.json();
                
                if (data.status === 'ok') {
                    gameState.playerId = data.player_id;
                    gameState.player = data.player;
                    
                    // Update UI
                    document.getElementById('characterSelection').style.display = 'none';
                    document.getElementById('gameArea').style.display = 'block';
                    
                    updateStats();
                    startLocationTracking();
                    showMessage(`Selected ${characterClass}! Start moving to find enemies.`, 'success');
                } else {
                    showMessage(data.error || 'Failed to select character', 'error');
                }
            } catch (error) {
                console.error('Character selection error:', error);
                showMessage('Failed to select character', 'error');
            }
        }

        // Start Location Tracking
        function startLocationTracking() {
            if (!navigator.geolocation) {
                showMessage('Geolocation not supported', 'error');
                return;
            }

            navigator.geolocation.watchPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    updateLocationStatus(lat, lon);
                    
                    // Send location to server
                    await updateLocation(lat, lon);
                },
                (error) => {
                    console.error('Location error:', error);
                    showMessage('Location access denied', 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );
        }

        // Update Location Status
        function updateLocationStatus(lat, lon) {
            const locationStatus = document.getElementById('locationStatus');
            locationStatus.textContent = `Location: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
            
            if (gameState.lastLocation) {
                const distance = calculateDistance(
                    gameState.lastLocation.lat, 
                    gameState.lastLocation.lon,
                    lat, lon
                );
                document.getElementById('distanceInfo').textContent = 
                    `Distance traveled: ${distance.toFixed(1)}m`;
            }
            
            gameState.lastLocation = { lat, lon };
        }

        // Calculate Distance
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Update Location on Server
        async function updateLocation(lat, lon) {
            try {
                const response = await fetch('/update-location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        lat: lat, 
                        lon: lon,
                        player_id: gameState.playerId 
                    })
                });
                
                const data = await response.json();
                
                if (data.spawn) {
                    // Enemy spawned!
                    gameState.enemy = data.enemy_stats;
                    gameState.inCombat = true;
                    showEnemy(data.enemy_stats);
                    showMessage(`Enemy encountered: ${data.enemy}!`, 'success');
                }
            } catch (error) {
                console.error('Location update error:', error);
                // Don't show error for location updates to avoid spam
            }
        }

        // Show Enemy
        function showEnemy(enemy) {
            const enemyInfo = document.getElementById('enemyInfo');
            enemyInfo.style.display = 'block';
            
            document.getElementById('enemyIcon').textContent = 
                enemy.type === 'class1' ? 'üëπ' : 
                enemy.type === 'class2' ? 'üë∫' : 'üêâ';
            document.getElementById('enemyName').textContent = enemy.name;
            
            updateEnemyHealth();
        }

        // Update Enemy Health
        function updateEnemyHealth() {
            if (!gameState.enemy) return;
            
            const healthPercent = (gameState.enemy.hp / gameState.enemy.max_hp) * 100;
            document.getElementById('enemyHealth').style.width = healthPercent + '%';
            document.getElementById('enemyStats').textContent = 
                `HP: ${gameState.enemy.hp}/${gameState.enemy.max_hp}`;
        }

        // Player Attack
        async function playerAttack() {
            if (!gameState.inCombat) {
                showMessage('No enemy to attack!', 'error');
                return;
            }
            
            try {
                const response = await fetch('/player-attack', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ player_id: gameState.playerId })
                });
                
                const data = await response.json();
                
                if (data.enemy_defeated) {
                    gameState.enemy = null;
                    gameState.inCombat = false;
                    document.getElementById('enemyInfo').style.display = 'none';
                    showMessage(`Enemy defeated! +${data.xp_gained} XP`, 'success');
                    updateStats();
                } else {
                    gameState.enemy = data.enemy_stats;
                    updateEnemyHealth();
                    updateStats();
                    
                    if (data.player_defeated) {
                        showMessage('You have been defeated!', 'error');
                        gameState.inCombat = false;
                    }
                }
            } catch (error) {
                console.error('Attack error:', error);
                showMessage('Attack failed', 'error');
            }
        }

        // Use Skill
        async function useSkill() {
            showMessage('Skill system coming soon!', 'success');
        }

        // Heal
        async function heal() {
            try {
                const response = await fetch('/heal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ player_id: gameState.playerId })
                });
                
                const data = await response.json();
                updateStats();
                showMessage(`Healed ${data.healed} HP!`, 'success');
            } catch (error) {
                console.error('Heal error:', error);
                showMessage('Heal failed', 'error');
            }
        // Update Stats
        function updateStats() {
            if (!gameState.player) return;
            
            document.getElementById('level').textContent = gameState.player.level;
            document.getElementById('hp').textContent = 
                `${gameState.player.current_hp}/${gameState.player.max_hp}`;
            document.getElementById('xp').textContent = gameState.player.xp;
            
            const totalKills = Object.values(gameState.player.kills).reduce((a, b) => a + b, 0);
            document.getElementById('kills').textContent = totalKills;
        }

        // Show Message
        function showMessage(text, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="message ${type}">${text}</div>`;
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 3000);
        }

        // Initialize on load
        window.onload = function() {
            showMessage('Welcome to AR RPG Adventure!', 'success');
        };
    </script>
</body>
</html>
