
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR RPG Adventure</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/css/game.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="game-container">
        <header class="game-header">
            <h1 class="game-title">‚öîÔ∏è AR RPG Adventure ‚öîÔ∏è</h1>
            <p class="game-subtitle">Battle enemies in the real world!</p>
        </header>

        <!-- Character Selection -->
        <section id="characterSelection" class="character-selection">
            <h2>Choose Your Hero</h2>
            <div class="character-grid">
                <div class="character-card" data-character="warrior">
                    <div class="character-icon">‚öîÔ∏è</div>
                    <div class="character-name">Warrior</div>
                    <div class="character-stats">
                        HP: 120 | ATK: 15<br>
                        Skills: Power Strike, Shield Bash, Battle Heal
                    </div>
                </div>
                <div class="character-card" data-character="mage">
                    <div class="character-icon">üîÆ</div>
                    <div class="character-name">Mage</div>
                    <div class="character-stats">
                        HP: 80 | ATK: 25<br>
                        Skills: Fireball, Arcane Missiles, Mana Shield
                    </div>
                </div>
                <div class="character-card" data-character="archer">
                    <div class="character-icon">üèπ</div>
                    <div class="character-name">Archer</div>
                    <div class="character-stats">
                        HP: 100 | ATK: 18<br>
                        Skills: Precise Shot, Rain of Arrows, Nature's Heal
                    </div>
                </div>
                <div class="character-card" data-character="healer">
                    <div class="character-icon">üíö</div>
                    <div class="character-name">Healer</div>
                    <div class="character-stats">
                        HP: 110 | ATK: 12<br>
                        Skills: Holy Light, Greater Heal, Divine Blessing
                    </div>
                </div>
                <div class="character-card" data-character="rogue">
                    <div class="character-icon">üó°Ô∏è</div>
                    <div class="character-name">Rogue</div>
                    <div class="character-stats">
                        HP: 90 | ATK: 20<br>
                        Skills: Backstab, Poison Blade, Shadow Mend
                    </div>
                </div>
            </div>
        </section>

        <!-- Game Stats -->
        <section id="gameStats" class="game-stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-title">Level</div>
                <div class="stat-value" id="playerLevel">1</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Health</div>
                <div class="stat-value" id="playerHP">120/120</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Experience</div>
                <div class="stat-value" id="playerXP">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Total Kills</div>
                <div class="stat-value" id="playerKills">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Skill Points</div>
                <div class="stat-value" id="skillPoints">0</div>
            </div>
        </section>

        <!-- Combat Area -->
        <section id="combatArea" class="combat-area" style="display: none;">
            <div class="enemy-container">
                <div class="enemy-name" id="enemyName">No Enemy</div>
                <div class="enemy-icon" id="enemyIcon">üëæ</div>
                
                <!-- Enemy Health Bar -->
                <div class="health-bar-container">
                    <div class="health-bar">
                        <div class="health-fill" id="enemyHealthFill" style="width: 100%"></div>
                        <div class="health-text" id="enemyHealthText">100/100 HP</div>
                    </div>
                </div>
            </div>

            <!-- Skills -->
            <div class="skills-container" id="skillsContainer">
                <!-- Skills will be populated here -->
            </div>

            <!-- Combat Messages -->
            <div class="combat-messages">
                <div class="message-toggle">
                    <span>Combat Log</span>
                    <button class="toggle-btn" id="toggleMessages">Show All (0)</button>
                </div>
                <div id="messagesList">
                    <!-- Messages will appear here -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="action-btn" id="attackBtn">‚öîÔ∏è Attack</button>
                <button class="action-btn" id="healBtn">üíö Heal</button>
                <button class="action-btn" id="spawnBtn">üëæ Spawn Enemy</button>
                <button class="action-btn" id="locationBtn">üìç Update Location</button>
            </div>
        </section>

        <!-- Level Up Modal -->
        <div id="levelUpModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h2>‚≠ê Level Up! ‚≠ê</h2>
                <p>Choose your reward:</p>
                <div class="level-up-choices">
                    <button class="choice-btn" id="skillUpgradeBtn">
                        <i class="fas fa-arrow-up"></i>
                        Skill Upgrade (+1 Skill Point)
                    </button>
                    <button class="choice-btn" id="fullHealBtn">
                        <i class="fas fa-heart"></i>
                        Full Heal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .level-up-choices {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .choice-btn {
            flex: 1;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #FFD700;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .choice-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateY(-3px);
        }

        .choice-btn i {
            display: block;
            font-size: 2rem;
            margin-bottom: 10px;
        }
    </style>

    <script>
        // Game State
        let gameState = {
            playerId: null,
            player: null,
            enemy: null,
            inCombat: false,
            allMessages: [],
            showAllMessages: false
        };

        // Character Selection
        document.querySelectorAll('.character-card').forEach(card => {
            card.addEventListener('click', function() {
                const character = this.dataset.character;
                selectCharacter(character);
            });
        });

        async function selectCharacter(characterClass) {
            try {
                const response = await fetch('/select-character', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({character: characterClass})
                });
                
                const data = await response.json();
                if (data.status === 'ok') {
                    gameState.playerId = data.player_id;
                    gameState.player = data.player;
                    
                    // Show game interface
                    document.getElementById('characterSelection').style.display = 'none';
                    document.getElementById('gameStats').style.display = 'grid';
                    document.getElementById('combatArea').style.display = 'block';
                    
                    updatePlayerStats();
                    loadSkills();
                    
                    // Get initial location
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(updateLocation);
                    }
                }
            } catch (error) {
                console.error('Error selecting character:', error);
            }
        }

        // Update Player Stats
        function updatePlayerStats() {
            if (gameState.player) {
                document.getElementById('playerLevel').textContent = gameState.player.level;
                document.getElementById('playerHP').textContent = `${gameState.player.current_hp}/${gameState.player.max_hp}`;
                document.getElementById('playerXP').textContent = gameState.player.xp;
                document.getElementById('playerKills').textContent = Object.values(gameState.player.kills).reduce((a, b) => a + b, 0);
                document.getElementById('skillPoints').textContent = gameState.player.skill_points || 0;
            }
        }

        // Load Skills
        async function loadSkills() {
            try {
                const response = await fetch(`/get-skills?player_id=${gameState.playerId}`);
                const data = await response.json();
                
                const skillsContainer = document.getElementById('skillsContainer');
                skillsContainer.innerHTML = '';
                
                data.skills.forEach(skill => {
                    const skillCard = document.createElement('div');
                    skillCard.className = `skill-card ${!skill.is_ready ? 'on-cooldown' : ''}`;
                    skillCard.innerHTML = `
                        <div class="skill-icon">${getSkillIcon(skill.type)}</div>
                        <div class="skill-name">${skill.name}</div>
                        <div class="skill-cooldown">${skill.is_ready ? 'Ready' : `${skill.remaining_cooldown.toFixed(1)}s`}</div>
                        ${skill.current_level > 0 ? `<div class="skill-level">Lv${skill.current_level}</div>` : ''}
                    `;
                    
                    if (skill.is_ready) {
                        skillCard.addEventListener('click', () => useSkill(skill.name));
                    }
                    
                    skillsContainer.appendChild(skillCard);
                });
            } catch (error) {
                console.error('Error loading skills:', error);
            }
        }

        function getSkillIcon(skillType) {
            const icons = {
                'damage': '‚öîÔ∏è',
                'heal': 'üíö',
                'buff': '‚ú®'
            };
            return icons[skillType] || 'üéØ';
        }

        // Use Skill
        async function useSkill(skillName) {
            try {
                const response = await fetch('/use-skill', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        player_id: gameState.playerId,
                        skill_name: skillName
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addCombatMessages(result.combat_messages || []);
                    updateEnemyHealth(result.enemy_health_percent);
                    updatePlayerStats();
                    
                    if (result.enemy_defeated) {
                        gameState.enemy = null;
                        showEnemyDefeated();
                    }
                    
                    loadSkills(); // Refresh skill cooldowns
                }
            } catch (error) {
                console.error('Error using skill:', error);
            }
        }

        // Combat Messages
        function addCombatMessages(messages) {
            gameState.allMessages.push(...messages);
            updateMessageDisplay();
        }

        function updateMessageDisplay() {
            const messagesList = document.getElementById('messagesList');
            const messagesToShow = gameState.showAllMessages ? 
                gameState.allMessages : 
                gameState.allMessages.slice(-3);
            
            messagesList.innerHTML = '';
            messagesToShow.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message-item ${getMessageType(message)}`;
                messageDiv.textContent = message;
                messagesList.appendChild(messageDiv);
            });
            
            // Update toggle button
            const toggleBtn = document.getElementById('toggleMessages');
            toggleBtn.textContent = gameState.showAllMessages ? 
                `Show Less (${gameState.allMessages.length})` : 
                `Show All (${gameState.allMessages.length})`;
        }

        function getMessageType(message) {
            if (message.includes('damage') || message.includes('Hit')) return 'message-damage';
            if (message.includes('heal') || message.includes('Heal')) return 'message-heal';
            if (message.includes('buff') || message.includes('reduction') || message.includes('boost')) return 'message-buff';
            if (message.includes('LEVEL UP')) return 'message-levelup';
            return '';
        }

        // Toggle Messages
        document.getElementById('toggleMessages').addEventListener('click', function() {
            gameState.showAllMessages = !gameState.showAllMessages;
            updateMessageDisplay();
        });

        // Enemy Health
        function updateEnemyHealth(healthPercent) {
            if (healthPercent !== undefined) {
                const healthFill = document.getElementById('enemyHealthFill');
                const healthText = document.getElementById('enemyHealthText');
                
                healthFill.style.width = `${healthPercent}%`;
                if (gameState.enemy) {
                    healthText.textContent = `${gameState.enemy.hp}/${gameState.enemy.max_hp} HP`;
                }
            }
        }

        function showEnemyDefeated() {
            document.getElementById('enemyName').textContent = 'Enemy Defeated!';
            document.getElementById('enemyIcon').textContent = 'üíÄ';
            document.getElementById('enemyHealthFill').style.width = '0%';
        }

        // Attack Button
        document.getElementById('attackBtn').addEventListener('click', async function() {
            if (!gameState.inCombat) return;
            
            try {
                const response = await fetch('/player-attack', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({player_id: gameState.playerId})
                });
                
                const result = await response.json();
                addCombatMessages(result.combat_messages || []);
                updateEnemyHealth(result.enemy_stats?.health_percent);
                updatePlayerStats();
                
                if (result.enemy_defeated) {
                    showEnemyDefeated();
                }
            } catch (error) {
                console.error('Error attacking:', error);
            }
        });

        // Heal Button
        document.getElementById('healBtn').addEventListener('click', async function() {
            try {
                const response = await fetch('/heal', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({player_id: gameState.playerId})
                });
                
                const result = await response.json();
                if (result.success) {
                    addCombatMessages([`üíö Healed for ${result.healed} HP!`]);
                    updatePlayerStats();
                }
            } catch (error) {
                console.error('Error healing:', error);
            }
        });

        // Spawn Enemy Button
        document.getElementById('spawnBtn').addEventListener('click', async function() {
            try {
                const response = await fetch('/spawn-enemy', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        player_id: gameState.playerId,
                        enemy_type: 'class1'
                    })
                });
                
                const result = await response.json();
                if (result.spawn) {
                    gameState.enemy = result.enemy_stats;
                    gameState.inCombat = true;
                    
                    document.getElementById('enemyName').textContent = result.enemy_stats.name;
                    document.getElementById('enemyIcon').textContent = getEnemyIcon(result.enemy);
                    updateEnemyHealth(100);
                    
                    addCombatMessages([`üëæ ${result.enemy_stats.name} appeared!`]);
                }
            } catch (error) {
                console.error('Error spawning enemy:', error);
            }
        });

        function getEnemyIcon(enemyType) {
            const icons = {
                'class1': 'üëπ',
                'class2': 'üë∫',
                'class3': 'üêâ'
            };
            return icons[enemyType] || 'üëæ';
        }

        // Update Location
        async function updateLocation(position) {
            if (!gameState.playerId) return;
            
            const lat = position?.coords?.latitude || 40.7128; // Default to NYC
            const lon = position?.coords?.longitude || -74.0060;
            
            try {
                const response = await fetch('/update-location', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        player_id: gameState.playerId,
                        lat: lat,
                        lon: lon
                    })
                });
                
                const result = await response.json();
                if (result.spawn) {
                    gameState.enemy = result.enemy_stats;
                    gameState.inCombat = true;
                    
                    document.getElementById('enemyName').textContent = result.enemy_stats.name;
                    document.getElementById('enemyIcon').textContent = getEnemyIcon(result.enemy);
                    updateEnemyHealth(100);
                    
                    let spawnMessage = `üëæ ${result.enemy_stats.name} appeared!`;
                    if (result.ar_location) {
                        spawnMessage += ` at ${result.ar_location.poi_name}`;
                    }
                    addCombatMessages([spawnMessage]);
                }
            } catch (error) {
                console.error('Error updating location:', error);
            }
        }

        document.getElementById('locationBtn').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(updateLocation);
            } else {
                updateLocation(); // Use default location
            }
        });

        // Level Up Modal
        document.getElementById('skillUpgradeBtn').addEventListener('click', async function() {
            try {
                const response = await fetch('/level-up-reward', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        player_id: gameState.playerId,
                        reward_type: 'skill_upgrade'
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('levelUpModal').style.display = 'none';
                    updatePlayerStats();
                    loadSkills();
                    addCombatMessages(['‚≠ê Skill point earned!']);
                }
            } catch (error) {
                console.error('Error claiming level up reward:', error);
            }
        });

        document.getElementById('fullHealBtn').addEventListener('click', async function() {
            try {
                const response = await fetch('/level-up-reward', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        player_id: gameState.playerId,
                        reward_type: 'full_heal'
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('levelUpModal').style.display = 'none';
                    updatePlayerStats();
                    addCombatMessages(['üíö Fully healed!']);
                }
            } catch (error) {
                console.error('Error claiming level up reward:', error);
            }
        });

        // Initialize
        updateMessageDisplay();
    </script>
</body>
</html>
